<!DOCTYPE html>
<html>
<head>
    <title>Eurovision 2017 Quiz</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="socket.io.js"></script>
    <link rel="stylesheet" href="./css/countrySelect.css">
    
    <script src="./js/countrySelect.min.js"></script>

    
</head>
<body>
    <div id></div>
    <div id="questionContainer">
        <h1 id=questionPlace>Enter your name!</h1>
    </div>
    <div id="answersContainer">
        <input type="text" id="username"></input>
        <input type="text" id="country"></input>
        <button id=buttonRegister>Register</button>
    </div>


    <!----------HERE STARTS SCRIPT------->

    <script>
    var question = JSON.parse('{ "id" : 1, "question" : "What is the capital of Ukraine?",\
            "answers":["Minsk","Belarus", "Moscow", "Kiev"],"rightAnswer" : "Kiev", "country":"IRAN"}');

    var socket = io("localhost:8080");
    function loadQuestion(newQuestion){
        clearPage();
        console.log(newQuestion);
        var question = newQuestion;
        var answers = '<ol class="divAnswers">\
        <li><button class="answer1" id="answer0">'+ question.answers[0] +'</button></li>\
        <li><button class="answer2" id="answer1">'+ question.answers[1] +'</button></li>\
        <li><button class="answer3" id="answer2">'+ question.answers[2] +'</button></li>\
        <li><button class="answer4" id="answer3">'+ question.answers[3] +'</button></li>\
        </ol>';
        $('#answersContainer').append(answers);
        //fix
        addTimer(5,newQuestion);
        
        $('#questionContainer').append('<h1>'+ question.question +'</h1>');
        $('#answer' + 0).click(function(){
            sendAnswer(newQuestion, question.answers[0],$('#seconds').val());
        });
        $('#answer' + 1).click(function(){
            sendAnswer(newQuestion, question.answers[1],$('#seconds').val());
        });
        $('#answer' + 2).click(function(){
            sendAnswer(newQuestion, question.answers[2],$('#seconds').val());
        });
        $('#answer' + 3).click(function(){
            sendAnswer(newQuestion, question.answers[3],$('#seconds').val());
        });

    }

    function addTimer(counter,newQuestion){
        var seconds = counter;
        $("#answersContainer").append('<div id="secondsContainer"></div>');
        $("#secondsContainer").append("<h2>"+seconds+"</h2>");
        var timer = setInterval(function(){
            seconds = seconds - 1;
            console.log(seconds);
            if(seconds === -1){
                clearInterval(timer);
                if(newQuestion != ""){
                sendAnswer(newQuestion,"timeout",-1);
                }
            }
            $("#secondsContainer").empty();
            $("#secondsContainer").append("<h2>"+seconds+"</h2>");

        }, 1000);
    }
        
    function sendAnswer(newQuestion,answer,timeRemaining){
       var question = newQuestion;
       socket.emit('answer',{
            "country" : newQuestion.country,
            "questionId" : newQuestion.id,
            "answer" : answer,
            "timeRemaining": timeRemaining,
            "userId" : localStorage.id            
        });
        if(timeRemaining < 0){
            if(answer === "timeout"){
            waitingScreen(2,newQuestion.rightAnswer,answer,timeRemaining);
            }
        }else{
            waitingScreen(1,newQuestion.rightAnswer,answer,timeRemaining);
        }
        
    }

        
    function clearPage(){
        $('#questionContainer').empty();
        $('#answersContainer').empty();
    }
        
    function register(){
        localStorage.username = $("#username").val();
        localStorage.id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
        return v.toString(16);
        });
        localStorage.country = $('#country');
        var registerObject = [];

       socket.emit('register',{
                   "id" : localStorage.id,
                   "username" : localStorage.username,
                   "contry" : localStorage.country,
                   "answers" : [],
                   "score"  :0
                    });

        waitingScreen(0,"","",0);
    }
    
    function waitingScreen(number,rightAnswer,answer,timeRemaining){
        clearPage();
        var answeredCorrectly = (rightAnswer === answer);
        switch (number){
            case 0:
                $('#questionContainer').append('<h1> Please wait </h1>');
                $('#answersContainer').append('<img src="https://media0.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif"></img>');
                break;
            case 1:
                $('#questionContainer').append('<h1> Waiting for others </h1>');
                var seconds = addTimer(timeRemaining + 5,"");
                clearPage();
                if(answeredCorrectly === true){
                    $('#questionContainer').append('<h1> You answered correctly </h1>');
                    $('#answersContainer').append('<p>You answered: ' + rightAnswer + '</p>');
                }else{
                    $('#questionContainer').append('<h1> Maybe next time </h1>');
                    $('#answersContainer').append('<p>The answer was' + rightAnswer +'</p>\
                                                  <p>You answered: ' + answer + '</p>');
                }
                socket.on('score',function(scores){
                    waitingScreen(3,"",scores,0);
                });
                break;
            case 2:
                $('#questionContainer').append('<h1> Ran out of time! </h1>');
                $('#answersContainer').append('<img src="https://media0.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif"></img>');
                addTimer(5,"");
                
                socket.on('score',function(scores){
                    waitingScreen(3,"",scores,0);
                });
                break;
            case 3:
                $('#questionContainer').append('<h1>Wait for next question!</h1>');
                $('#answersContainer').append("<p>You're place number: " + answer + "</p>");
                socket.on('newQuestion',loadQuestion);
                break;
            default:
                break;
        }
        
    }
        
    /**

    if(localStorage.username === null){
        $("#country").countrySelect();
    }else{
        waitingScreen(0,"","",0);
    }
        
    $("#buttonRegister").click(function(){
        register();
    });
    */
        loadQuestion(question);
        
    
    
    
    </script>
</body>
</html>