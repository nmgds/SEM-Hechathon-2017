<!DOCTYPE html>
<html>
<head>
    <title>Eurovision 2017 Quiz</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css">

    <link rel="stylesheet" href="./css/countrySelect.css">
    <link rel="stylesheet" href="./css/client.css">
    
    <script src="./js/countrySelect.min.js"></script>

    
</head>
<body>
    <div class="container">

        <div class="row">
            <div id="questionContainer">
                <img src="./img/logo.svg">
            </div>
        </div>
        
        <div id="answersContainer" class="row">
            <div>
                <input type="text" id="username" class="defaultInput"></input>
            </div>
            <div>
                <input type="text" id="country" class="defaultInput"></input>
            </div>
            <div>
                <button class="waves-effect waves-light btn" id=buttonRegister>Register</button>
            </div>
        </div>

    </div>

    <script>
    
    var socket = io("leia.skip.chalmers.se:8080");
     //   var socket = io("localhost:8080");
        
    socket.on('score',function(scores){
        setTimeout(function(){
            waitingScreen(3,"",scores,0);
        },5000);
    });
    socket.on('newQuestion',loadQuestion);

    
    var timerCounter = 0;
    var answeredQuestion = false;

    function loadQuestion(newQuestion){
        answeredQuestion = false;
        clearPage();
        console.log(newQuestion);
        var question = newQuestion;
        var answers = '<ol class="divAnswers">\
        <li><button class="waves-effect waves-light btn" id="answer0">'+ question.answers[0] +'</button></li>\
        <li><button class="waves-effect waves-light btn" id="answer1">'+ question.answers[1] +'</button></li>\
        <li><button class="waves-effect waves-light btn" id="answer2">'+ question.answers[2] +'</button></li>\
        <li><button class="waves-effect waves-light btn" id="answer3">'+ question.answers[3] +'</button></li>\
        </ol>';
        $('#answersContainer').append(answers);
        //fix
        addTimer(15,newQuestion);
        
        $('#questionContainer').append('<h1>'+ question.question +'</h1>');
        $('#answer' + 0).click(function(){
            sendAnswer(newQuestion, question.answers[0],timerCounter);
        });
        $('#answer' + 1).click(function(){
            sendAnswer(newQuestion, question.answers[1],timerCounter);
        });
        $('#answer' + 2).click(function(){
            sendAnswer(newQuestion, question.answers[2],timerCounter);
        });
        $('#answer' + 3).click(function(){
            sendAnswer(newQuestion, question.answers[3],timerCounter);
        });

    }

    function addTimer(counter,newQuestion){
        timerCounter = counter;
        $("#answersContainer").append('<div id="secondsContainer"></div>');
        $("#secondsContainer").append("<h2 id='seconds'>"+timerCounter+"</h2>");
        console.log("running timer");
        var timer = setInterval(function(){
            timerCounter = timerCounter - 1;
            console.log(timerCounter);
            if(timerCounter <= 0){
                clearInterval(timer);
                $("#seconds").innerHTML = timerCounter;
                if(!answeredQuestion){
                    sendAnswer(newQuestion,"timeout",-1);
                }    
            }
            $("#secondsContainer").empty();
            $("#secondsContainer").append("<h2 id='seconds'>"+timerCounter+"</h2>");

        }, 1000);
    }
        
    function sendAnswer(newQuestion,answer,timeRemaining){
        if(answer != "timeout"){
            answeredQuestion = true;
        }
       var question = newQuestion;
        var response = {
            "country" : newQuestion.country,
            "answer" : answer,
            "timeRemaining": timeRemaining,
            "userId" : localStorage.id            
        };
        console.log(response);
       socket.emit('answer',{
            "country" : newQuestion.country,
            "answer" : answer,
            "timeRemaining": timeRemaining,
            "userId" : localStorage.id            
        });
        
        
        
        
        if(timeRemaining < 0 && answer === "timeout"){
            waitingScreen(2,newQuestion.rightAnswer,answer,timeRemaining);
        }else{
            waitingScreen(1,newQuestion.rightAnswer,answer,timeRemaining);
        }
        
    }

        
    function clearPage(){
        $('#questionContainer').empty();
        $('#answersContainer').empty();
    }
        
    function register(){
        localStorage.username = $("#username").val();
        localStorage.id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
        return v.toString(16);
        });
        localStorage.country = $("#country").countrySelect("getSelectedCountryData").iso2;
        var registerObject = [];

       socket.emit('register',{
                   "id" : localStorage.id,
                   "username" : localStorage.username,
                   "country" : localStorage.country,
                   "answers" : [],
                   "score"  :0
                    });

        waitingScreen(0,"","",0);
    }
    
    function waitingScreen(number,rightAnswer,answer,timeRemaining){
        clearPage();
        var answeredCorrectly = (rightAnswer === answer);
        switch (number){
            case 0:
                $('#questionContainer').append('<h1> Please wait </h1>');
                $('#answersContainer').append('<img src="https://media0.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif"></img>');
                break;
            case 1:
                $('#questionContainer').append('<h1> Waiting for others </h1>');
                setTimeout(function(){
                    clearPage();
                    if(answeredCorrectly === true){
                        $('#questionContainer').append('<h1> You answered correctly </h1>');
                        $('#answersContainer').append('<p>You answered: ' + rightAnswer + '</p>');
                    }else{
                        $('#questionContainer').append('<h1> Maybe next time </h1>');
                        $('#answersContainer').append('<p>The answer was' + rightAnswer +'</p>\
                                                      <p>You answered: ' + answer + '</p>');
                    }
                },timeRemaining * 1000);
                

                break;

            case 2:
                $('#questionContainer').append('<h1> Ran out of time! </h1>');
                $('#answersContainer').append('<img src="./img/load.gif"></img>');
                break;
                
            case 3:
                $('#questionContainer').append('<h1>Wait for next question!</h1>');
                $('#answersContainer').append("<p>You're place number: " + answer + "</p>");
                break;
            default:
                break;
        }
        
    }
        

    if(localStorage.username === null || localStorage.username === undefined){
        $("#country").countrySelect();
    }else{
        waitingScreen(0,"","",0);
    }
        
    $("#buttonRegister").click(function(){
        register();
    });
    
    
    </script>
</body>
</html>